{% extends 'master.html' %}
{% load static %}

{% block title %}
ForoVox | {{ foro.nombre }}
{% endblock %}

{% block content %}

{% if tipUsuario == "Admin" %}
  {% include 'components/admin-display.html' %}
{% else %}
  {% include 'components/usuario-display.html' %}
{% endif %}

<div class="flex justify-center min-h-screen">
  <div class="flex flex-col items-center xl:items-start max-w-7xl w-full px-4 xl:pl-[25rem]">
    
    <div class="w-full bg-white dark:bg-gray-800 shadow-xl rounded-2xl border border-gray-200 dark:border-gray-700 overflow-hidden mb-10 relative group">
       <div class="h-32 bg-gradient-to-r from-slate-200 to-slate-400 dark:from-blue-900 dark:to-slate-900 relative overflow-hidden">
          <div class="absolute inset-0 bg-black/10"></div>
       </div>

       <div class="px-6 sm:px-10 pb-8">
          <div class="relative flex flex-col md:flex-row items-center md:items-end -mt-12 gap-6 text-center md:text-left">
             
             <div class="relative shrink-0">
                {% if foro.imagen %}
                  <img src="{{ foro.imagen.url }}" alt="Imagen del Foro" 
                       class="h-32 w-32 rounded-2xl border-4 border-white dark:border-gray-800 shadow-lg object-cover bg-white dark:bg-gray-700">
                {% else %}
                  <img src="{% static 'imagenes/tabula_rasa.png' %}" alt="Imagen del foro" 
                       class="h-32 w-32 rounded-2xl border-4 border-white dark:border-gray-800 shadow-lg object-cover bg-white dark:bg-gray-700">
                {% endif %}
             </div>

             <div class="flex-1 w-full md:pb-2">
                <div class="flex flex-col md:flex-row justify-between items-center md:items-end gap-4">
                   
                   <div class="flex-1" x-data="{ expanded: false }">
                      <h1 class="text-3xl font-bold text-gray-900 dark:text-white tracking-tight mb-2">{{ foro.nombre }}</h1>
                      
                      <div x-show="!expanded" class="relative">
                        <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed max-w-2xl mx-auto md:mx-0">
                          {{ foro.descripcion|truncatewords:40 }}
                          {% if foro.descripcion|wordcount > 40 %}...{% endif %}
                        </p>
                      </div>

                      <div x-show="expanded" x-transition style="display: none;">
                        <p class="text-gray-500 dark:text-gray-400 text-sm leading-relaxed max-w-2xl mx-auto md:mx-0">
                          {{ foro.descripcion }}
                        </p>
                      </div>

                      {% if foro.descripcion|wordcount > 40 %}
                      <button @click="expanded = !expanded" class="text-blue-600 dark:text-blue-400 text-sm font-medium hover:underline mt-2 focus:outline-none">
                        <span x-show="!expanded">Leer más</span>
                        <span x-show="expanded" style="display: none;">Leer menos</span>
                      </button>
                      {% endif %}
                   </div>
                   <a href="{% url 'crear_publicacion' foro.id %}" 
                      class="shrink-0 flex items-center gap-2 px-6 py-3 rounded-xl text-sm font-semibold bg-blue-600 hover:bg-blue-700 text-white shadow-lg shadow-blue-600/20 transition-all transform hover:-translate-y-0.5 hover:shadow-blue-600/30">
                      Crear Post <i class="ri-add-line text-lg"></i>
                   </a>
                </div>
             </div>
          </div>
       </div>
    </div>
    
    {% if publicaciones %}
    <div class="w-full max-w-4xl space-y-6">
      {% for publicacion in publicaciones reversed %}
      
      <div class="group relative bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm hover:shadow-xl transition-all duration-300 ease-out hover:-translate-y-1">
        
        <div class="flex items-start justify-between mb-4">
          <div class="flex items-center gap-3">
            <a href="{% url 'perfil_usuario' publicacion.usuario.id %}" class="relative">
              {% if publicacion.usuario.foto %}
                <img src="{{ publicacion.usuario.foto.url }}" alt="Avatar" class="h-10 w-10 rounded-full object-cover ring-2 ring-transparent group-hover:ring-blue-500/30 transition-all">
              {% else %}
                <img src="{% static 'imagenes/default-profile.png' %}" alt="Avatar" class="h-10 w-10 rounded-full object-cover ring-2 ring-transparent group-hover:ring-blue-500/30 transition-all">
              {% endif %}
            </a>
            
            <div class="flex flex-col">
                <a href="{% url 'perfil_usuario' publicacion.usuario.id %}" class="text-sm font-semibold text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors">
                    {{ publicacion.usuario.nombres }}
                </a>
                <span class="text-xs text-gray-400 dark:text-gray-500">
                    {{ publicacion.fecha|date:"d M Y, H:i" }}
                </span>
            </div>
          </div>

          {% if request.session.idUsuario == publicacion.usuario.id or request.session.tipUsuario == 'Admin' %}
          <div class="relative">
            <button 
              class="flex items-center justify-center h-8 w-8 rounded-full text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors focus:outline-none"
              data-popover-target="postMenu-{{ forloop.counter }}">
              <i class="ri-more-fill text-xl"></i>
            </button>
            
            <ul role="menu" data-popover="postMenu-{{ forloop.counter }}" 
                class="absolute z-20 right-0 top-full mt-1 w-40 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg py-1 hidden transform origin-top-right transition-all">
              <li>
                <a href="{% url 'mostrar_publicacion' foro.id publicacion.id %}" 
                   class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                   <i class="ri-eye-line"></i> Ver
                </a>
              </li>
              <li>
                <a href="{% url 'editar_publicacion' foro.id publicacion.id %}" 
                   class="flex items-center gap-2 px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-700">
                   <i class="ri-edit-line"></i> Editar
                </a>
              </li>
              <li>
                <button 
                   class="delete-post-btn w-full text-left flex items-center gap-2 px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20"
                   data-url="{% url 'eliminar_publicacion' foro.id publicacion.id %}"
                   data-titulo="{{ publicacion.titulo }}">
                   <i class="ri-delete-bin-line"></i> Eliminar
                </button>
              </li>
            </ul>
          </div>
          {% endif %}
        </div>

        <a href="{% url 'mostrar_publicacion' foro.id publicacion.id %}" class="block group-hover:opacity-90 transition-opacity">
            <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-2 line-clamp-2 group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                {{ publicacion.titulo }}
            </h2>
            <p class="text-gray-600 dark:text-gray-300 text-sm leading-relaxed line-clamp-3">
                {{ publicacion.texto }}
            </p>
        </a>

        <div class="mt-4 pt-4 border-t border-gray-100 dark:border-gray-700 flex justify-between items-center">
            <a href="{% url 'mostrar_publicacion' foro.id publicacion.id %}" class="text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline flex items-center gap-1">
                Leer completo <i class="ri-arrow-right-line"></i>
            </a>
        </div>

      </div>
      {% endfor %}
    </div>

    {% else %}
    <div class="w-full flex flex-col items-center justify-center py-16 px-4 text-center bg-white dark:bg-gray-800 rounded-2xl border border-dashed border-gray-300 dark:border-gray-700">
        <div class="h-20 w-20 bg-gray-50 dark:bg-gray-700/50 rounded-full flex items-center justify-center mb-4">
            <i class="ri-chat-1-line text-4xl text-gray-300 dark:text-gray-500"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">No hay publicaciones aún</h3>
        <p class="text-gray-500 dark:text-gray-400 max-w-md mb-6">
            Este foro está muy tranquilo. ¡Sé la primera persona en iniciar una conversación interesante!
        </p>
        <a href="{% url 'crear_publicacion' foro.id %}" class="px-5 py-2.5 rounded-lg text-sm font-medium bg-blue-600 text-white hover:bg-blue-700 transition-colors shadow-md">
            Crear primera publicación
        </a>
    </div>
    {% endif %}
  </div>
</div>

<div id="deleteModal" class="fixed inset-0 z-50 hidden flex items-center justify-center px-4 bg-black/60 backdrop-blur-sm transition-opacity duration-300">
  <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-2xl w-full max-w-md p-6 transform scale-100 transition-all">
    <div class="flex items-center gap-4 mb-5">
      <div class="p-3 bg-red-100 dark:bg-red-900/30 rounded-full text-red-600 dark:text-red-400">
         <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
           <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
         </svg>
      </div>
      <div>
        <h2 class="text-lg font-bold text-gray-900 dark:text-white">Eliminar Publicación</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400">Esta acción no se puede deshacer.</p>
      </div>
    </div>
    
    <p id="modalMessage" class="text-sm text-gray-600 dark:text-gray-300 mb-8 ml-1">
      ¿Estás seguro que deseas eliminar esta publicación?
    </p>
    
    <div class="flex justify-end space-x-3">
      <button id="cancelButton"
        class="px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-200 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition-colors">
        Cancelar
      </button>
      <button id="confirmDeleteButton"
        class="px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 dark:bg-red-600 dark:hover:bg-red-500 rounded-lg shadow-lg shadow-red-500/30 transition-all">
        Sí, Eliminar
      </button>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script src="{% static 'js/ver_foro.js' %}"></script>
{% endblock %}